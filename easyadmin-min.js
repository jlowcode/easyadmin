/**
 * Easy Admin
 *
 * @copyright: Copyright (C) 2005-2016  Media A-Team, Inc. - All rights reserved.
 * @license  : GNU/GPL http                         :                              //www.gnu.org/copyleft/gpl.html
 */
define(["jquery","fab/list-plugin"],(function(jQuery,FbListPlugin){var FbListEasyadmin=new Class({Extends:FbListPlugin,options:{inputSearch:"",labelList:"",fatherList:"",valIdEl:0},initialize:function(e){self=this,this.options=e,this.setElementsDatabasejoin(),this.setElementType(),this.setElementShowInList(),this.setUpButtonSave(),this.setUpButtonsPainel(),Fabrik.addEvent("fabrik.list.submit.ajax.complete",(function(){self.setUpButtonsPainel()}))},setUpButtonsPainel:function(){const e=jQuery("th.heading.fabrik_ordercell.fabrik_actions")[0];"inline"==this.options.actionMethod?jQuery(e).find(".btn-group")[0]:jQuery(e).find(".dropdown-menu")[0];this.setButtons(this.options.elements),this.setActionPanel(this.options.elements),jQuery(document).ready((function(){jQuery(document).on("mouseenter",".heading.fabrik_ordercell",(function(){jQuery(this).find(":button.elementAdminButton").show()})).on("mouseleave",".heading.fabrik_ordercell",(function(){jQuery(this).find(":button.elementAdminButton").hide()}))}))},createButton:function(e){var a=jQuery('<a href="#'+self.options.idModal+'" data-bs-toggle="modal">'+this.options.images.edit+"</a>"),t=jQuery('<li value="'+e+'" style="font-size: 12px;"></li>').css({cursor:"pointer"});return a.appendTo(t),a.on("click",(function(){self.setModalToEditElement(this)})),t},setElementsDatabasejoin:function(){self=this,jQuery(".select2-search__field").on("change",(function(){jQuery(this).remove(),self.options.inputSearch=jQuery(this)})),jQuery(document).on("click",".select2-selection__choice__remove",(function(){self.options.inputSearch.on("change",(function(){jQuery(this).remove(),self.options.inputSearch=jQuery(this)})),jQuery(this).parent().remove(),jQuery(".select2-selection__rendered li").append(self.options.inputSearch),self.setUpElementList()})),jQuery(".select2-selection").on("click",(function(){var e=jQuery(this);0==e.find(".select2-search__field").length&&0==e.find(".select2-selection__rendered li").length&&(e.find(".select2-search").append(self.options.inputSearch),self.setUpElementList())})),this.setUpElementList()},setUpElementList:function(){var self=this,searchElementList=jQuery("#easyadmin_modal___list .select2-search__field");searchElementList.on("change",(function(){setTimeout((function(){var tid=jQuery(".select2-selection__choice").attr("title");if(tid){var url="index.php?option=com_fabrik&format=raw&task=plugin.pluginAjax&g=element&plugin=field&method=ajax_fields&showall=1&cid=1&t='"+tid+"'";jQuery.ajax({url:url,method:"get",data:{showRaw:!1,k:2}}).done((function(r){var opts=eval(r),els=document.getElementsByClassName("child-element-list");jQuery(".child-element-list").each((function(e,a){jQuery(a).empty()})),opts.forEach((e=>{var a={value:e.value};e.value===self.options.labelList&&(a.selected="selected"),Array.each(els,(function(t){new Element("option",a).set("text",e.label).inject(t)}))}))}))}}),200)}))},setElementType:function(){var e=jQuery("#easyadmin_modal___type");e.on("change",(function(){type=jQuery(this).val(),jQuery(".modal-element").each((function(e,a){elementClass=jQuery(this).prop("class"),elementClass.indexOf("element-")<0&&(elementClass.indexOf("type-"+type)<0?jQuery(this).parent().addClass("fabrikHide"):jQuery(this).parent().removeClass("fabrikHide"))}))})),type=e.val(),jQuery(".modal-element").each((function(e,a){elementClass=jQuery(this).prop("class"),elementClass.indexOf("element-")<0&&(elementClass.indexOf("type-"+type)<0?jQuery(this).parent().addClass("fabrikHide"):jQuery(this).parent().removeClass("fabrikHide"))}))},setElementShowInList:function(){jQuery('input[name="easyadmin_modal___show_in_list"]').on("change",(function(){self.showHideElements("show_in_list")}))},showHideElements:function(e){jQuery(".modal-element").each((function(){elementClass=jQuery(this).prop("class"),elementClass.indexOf("element-"+e)>0&&(show=!!jQuery("#easyadmin_modal___"+e+"1").prop("checked")||"",show?jQuery(this).parent().removeClass("fabrikHide"):jQuery(this).parent().addClass("fabrikHide"))}))},setUpButtonSave:function(){elSaveElements=jQuery("#easyadmin_modal___submit_elements"),elSaveList=jQuery("#easyadmin_modal___submit_list"),elSaveElements.on("click",(()=>this.saveEvent("elements"))),elSaveList.on("click",(()=>this.saveEvent("list")))},saveEvent:function(e){if(valEls={},inputs=jQuery(".fabrikinput"),listId=jQuery("[name=listid]").val(),db_table_name=jQuery("[name=db_table_name]").val(),valEls.easyadmin_modal___mode=e,valEls.easyadmin_modal___listid=listId,valEls.jform={db_table_name:db_table_name},valEls.easyadmin_modal___valIdEl=self.options.valIdEl,inputs.each((function(){switch(id=this.id,id){case"easyadmin_modal___name":case"easyadmin_modal___type":case"easyadmin_modal___default_value":case"easyadmin_modal___options_dropdown":case"easyadmin_modal___label":case"easyadmin_modal___father":case"easyadmin_modal___format":case"easyadmin_modal___access_rating":case"easyadmin_modal___name_list":case"easyadmin_modal___description_list":case"easyadmin_modal___ordering_list":case"easyadmin_modal___ordering_type_list":case"easyadmin_modal___default_layout":case"easyadmin_modal___width_field":case"easyadmin_modal___ordering_elements":valEls[id]=jQuery(this).val();break;case"easyadmin_modal___use_filter1":case"easyadmin_modal___required1":case"easyadmin_modal___show_in_list1":case"easyadmin_modal___ajax_upload1":case"easyadmin_modal___make_thumbs1":case"easyadmin_modal___multi_select1":case"easyadmin_modal___multi_relation1":id=id.replace("1",""),valEls[id]=!!jQuery(this).prop("checked")||""}})),valEls.easyadmin_modal___list=jQuery('[name="easyadmin_modal___list[]"]').val()[0],valEls.order_by=[valEls.easyadmin_modal___ordering_list],valEls.order_dir=[valEls.easyadmin_modal___ordering_type_list],""!=valEls.easyadmin_modal___name_list){jQuery.ajax({url:"index.php?option=com_fabrik&format=raw&task=plugin.pluginAjax&g=list&plugin=easyadmin&method=SaveModal",method:"post",data:valEls}).done((function(e){(e=JSON.parse(e)).error?alert(e.message):(alert(Joomla.JText._("PLG_FABRIK_LIST_EASY_ADMIN_SUCCESS")),window.location.reload())}))}else alert(Joomla.JText._("PLG_FABRIK_LIST_EASY_ADMIN_ERROR_VALIDATE"))},setButtons:function(e){for(var a in e)if(e.hasOwnProperty(a)&&e[a].enabled){var t=jQuery("th."+e[a].fullname).children();t.css({display:"flex"}),t.addClass("tooltip2");var s=this.createButton(a);t.append(s),t.css({"min-width":"120px;"})}},setActionPanel:function(e){if("inline"==this.options.actionMethod)this.setActionPanelInline(e);else{if("dropdown"!=this.options.actionMethod)throw new Error(Joomla.JText._("PLG_FABRIK_LIST_EASY_ADMIN_ACTION_METHOD_ERROR"));this.setActionPanelDropdown(e)}},setActionPanelInline:function(e){var a=this,t=jQuery('<a class="btn fabrik_view fabrik__rowlink btn-default"><span>'+this.options.images.admin+'</span><span class="hidden">'+Joomla.JText._("PLG_FABRIK_LIST_EASY_ADMIN_ADMIN")+"</span></a>"),s=jQuery("th.heading.fabrik_ordercell.fabrik_actions")[0],n=jQuery(s).find(".btn-group")[0],i=jQuery('<li><button href="#'+a.options.idModalList+'" data-bs-toggle="modal" type="button">'+Joomla.JText._("PLG_FABRIK_LIST_EASY_ADMIN_EDIT_LIST")+"</button></li>"),l=jQuery('<li><button href="#'+a.options.idModal+'" data-bs-toggle="modal" type="button">'+Joomla.JText._("PLG_FABRIK_LIST_EASY_ADMIN_ADD_ELEMENT")+"</button></li>");if(!n){var o=jQuery('<div class="btn-group"></div>');jQuery(s).find("span").append(o),n=jQuery(s).find(".btn-group")[0]}var d=jQuery(n);this.setCssAndEventsButtons(i,l);var _=jQuery("<div></div>");_.css({"font-size":"12px",position:"absolute","z-index":100,"background-color":"#FFF",display:"none",right:"50%",padding:"10px",border:"2px solid #eee","border-radius":"4px","text-align":"left",width:"150px"}),t.on("click",(function(){"none"==jQuery(_).css("display")?jQuery(_).css({display:"block"}):jQuery(_).css({display:"none"})})),d.append(t),_.append(l),jQuery.each(e,(function(e,t){var s=jQuery('<li value="'+e+'" style="font-size: 12px"></li>').css({"font-size":"12px"}).appendTo(_);if(t.enabled)var n=jQuery('<a href="#'+a.options.idModal+'" data-bs-toggle="modal"></a>').text(a.options.elementsNames[e]).css({cursor:"pointer","padding-left":"10px"}).appendTo(s);else n=jQuery("<b/>").text(a.options.elementsNames[e]).css({"padding-left":"10px",color:"#999"}).appendTo(s);n.on("click",(function(){a.setModalToEditElement(this)}))})),_.append(i),d.append(_)},setModalToEditElement:function(e){self=this;var a=jQuery(e).parent().prop("value"),t=self.options.elements[a];self.options.valIdEl=a,t.enabled&&jQuery.each(t,(function(a,t){if((e=jQuery("#easyadmin_modal___"+a)).length>0)if(0==e.find(".switcher").length)switch(e.val(t),a){case"label":self.options.labelList=t;break;case"father":self.options.fatherList=t;break;case"list":var s=jQuery('<li class="select2-selection__choice" title="'+t+'" data-select2-id="18"><span class="select2-selection__choice__remove" role="presentation">Ã—</span>'+t+"</li>"),n=jQuery('<option value="'+t+'" data-select2-id="18">'+t+"</option>");jQuery('[name="easyadmin_modal___list[]"] > option').remove(),jQuery('[name="easyadmin_modal___list[]"]').append(n),jQuery('[name="easyadmin_modal___list[]"]').val(t),jQuery("#easyadmin_modal___"+a+" .select2-selection__choice").remove(),jQuery("#easyadmin_modal___"+a+" .select2-selection__rendered").append(s),jQuery("#easyadmin_modal___"+a+" .select2-search__field").trigger("change");break;case"width_field":case"ordering_elements":self.showHideElements("show_in_list")}else p=t?1:0,elSw=e.find("#easyadmin_modal___"+a+p),elSw.prop("checked",!0)})),jQuery("#easyadmin_modal___type").trigger("change")},setActionPanelDropdown:function(e){var a=this,t=jQuery('<li class="nav-link"><a title="Admin"><span>'+this.options.images.admin+"</span> "+Joomla.JText._("PLG_FABRIK_LIST_EASY_ADMIN_ADMIN")+"</a></li>"),s=jQuery("th.heading.fabrik_ordercell.fabrik_actions")[0],n=jQuery(s).find(".dropdown-menu")[0],i=jQuery('<li class="subMenuAdmin" style="display: none; padding: 0px 10px;"><button href="#'+a.options.idModalList+'" data-bs-toggle="modal" type="button">'+Joomla.JText._("PLG_FABRIK_LIST_EASY_ADMIN_EDIT_LIST")+"</button></li>"),l=jQuery('<li class="subMenuAdmin" style="display: none; padding: 0px 10px;"><button href="#'+a.options.idModal+'" data-bs-toggle="modal" type="button">'+Joomla.JText._("PLG_FABRIK_LIST_EASY_ADMIN_ADD_ELEMENT")+"</button></li>");if(!n){var o=jQuery('<div class="dropdown fabrik_action"><button class="btn btn-default btn-mini dropdown-toggle dropdown-toggle-no-caret" type="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="fa fa-angle-down" aria-hidden="true"></i></button><ul class="dropdown-menu dropdown-menu-end" style=""></ul></div>');jQuery(s).find("span").append(o),n=jQuery(s).find(".dropdown-menu")[0]}var d=jQuery(n);this.setCssAndEventsButtons(i,l),t.on("click",(function(){jQuery.each(jQuery(this).parent().find(".subMenuAdmin"),(function(){"none"==jQuery(this).css("display")?jQuery(this).css({display:"block"}):jQuery(this).css({display:"none"})})),setTimeout((()=>jQuery(this).closest(".dropdown").find(".dropdown-toggle").click()),5)})),d.append(t),t.append(l),jQuery.each(e,(function(e,s){var n=jQuery('<li value="'+e+'" style="font-size: 12px; display: none;" class="subMenuAdmin"></li>').css({"font-size":"12px"}).appendTo(t);if(s.enabled)var i=jQuery('<a href="#'+a.options.idModal+'" data-bs-toggle="modal"></a>').text(a.options.elementsNames[e]).css({cursor:"pointer","padding-left":"10px"}).appendTo(n);else i=jQuery("<b/>").text(a.options.elementsNames[e]).css({"padding-left":"10px",color:"#999"}).appendTo(n);i.on("click",(function(){a.setModalToEditElement(this)}))})),t.append(i)},setCssAndEventsButtons:function(e,a){var t=this;a.on("click",(function(){t.options.valIdEl=0,Els=jQuery(".fabrikinput"),Els.each((function(){switch(id=this.id,id){case"easyadmin_modal___name":case"easyadmin_modal___type":case"easyadmin_modal___default_value":case"easyadmin_modal___options_dropdown":case"easyadmin_modal___label":case"easyadmin_modal___father":case"easyadmin_modal___format":case"easyadmin_modal___access_rating":case"easyadmin_modal___width_field":case"easyadmin_modal___ordering_elements":jQuery(this).val("");break;case"easyadmin_modal___use_filter0":case"easyadmin_modal___required0":case"easyadmin_modal___show_in_list0":case"easyadmin_modal___ajax_upload0":case"easyadmin_modal___make_thumbs0":case"easyadmin_modal___multi_select0":case"easyadmin_modal___multi_relation0":jQuery(this).prop("checked",!0)}})),jQuery("#easyadmin_modal___list .select2-selection__choice__remove").trigger("click"),jQuery("#easyadmin_modal___label").empty(),jQuery("#easyadmin_modal___father").empty()})),e.find("button").css({"min-height":"30px","font-size":"12px",width:"100%","border-radius":"12px",color:"#000","background-color":"#e3ecf1","margin-top":"20px"}),a.find("button").css({"min-height":"30px","font-size":"12px",width:"100%","border-radius":"12px",color:"#fff","background-color":"#003EA1","margin-bottom":"5px"})}});return FbListEasyadmin}));